<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css' integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <title>Library</title>
        <style>
            body {font-family: Arial, Helvetica, sans-serif;}

            /* Table styling */
            #library {
                font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
                border-collapse: collapse;
                width: 100%;
                text-align: left;
                table-layout: fixed;
            }
            
            /* All rows styling */
            #library td, #library th {
                border-bottom: 2px solid #ddd;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 3px 15px 3px 15px;
            }

            /* Table header row styling */
            #library th {
                background-color: #0B304D;
                color: white;
            }

            /* Table column width specifications */
            #library th:nth-child(1) {width: 5%;}
            #library th:nth-child(2) {width: 5%;}
            #library th:nth-child(3) {width: 25%;}
            #library th:nth-child(4) {width: 5%;}
            #library th:nth-child(5) {width: 20%;}
            #library th:nth-child(6) {width: 20%;}
            #library th:nth-child(7) {width: 10%;}
            #library th:nth-child(8) {width: 10%;}
            

            /* Non-header row styling */
            #library td, #library td#duration {
                height: 40px;
            }
              
            /* Zebra table effect */
            #library tr:nth-child(even){background-color: #f2f2f2;}

            /* Change color on row hover */
            #library tr:hover td {
                background-color: #ddd;
            }
              
            /* Show the play button on row hover, and always show pause button */
            #library tr:hover td button#play, #library tr td button#pause, #library tr td button#saved {
                background-color: transparent;
                color: #0b304d;
                /* margin: 8px 0; */
                border: none;
                width: auto;
                text-align: center;
                display: inline-block;
                font-size: 27px;
                -webkit-transition-duration: 0.1s;
                transition-duration: 0.1s;
                opacity: 0.8
            }

            #library tr td button#saved {
                font-size: 20px;
                width: 30px;
            }

            /* Removes blue outline when play/pause button is selected */
            button:focus {outline:0}

            /* Transition animation on hover over button */
            #library tr:hover td button#play:hover, #library tr td button#pause:hover {
                transform: scale(1.1);
                opacity: 1.0;
            }

            /* Transition animation on button click */
            #library tr:hover td button#play:active, #library tr td button#pause:active {
                transform: scale(0.9);
                opacity: 0.6;
            }

            /* Don't show play button when not on row hover */
            #library tr td button#play {
                display: none;
            }

            /* Bottom locked bar for the song progress bar */
            .navbar {
                background-color: #0b304d;
                overflow: hidden;
                position: fixed;
                bottom: 0;
                width: 100%;                
            }

            .timebar {
                padding: 15px 15px 15px 15px;
            }

            /****** All below CSS involves the top navigation bar ******/
            .topnav {
                overflow: hidden;
                background-color: #e9e9e9;
            }
              
            .topnav a {
                float: left;
                display: block;
                color: black;
                text-align: center;
                padding: 14px 16px;
                text-decoration: none;
                font-size: 17px;
            }
              
            .topnav a:hover {
                background-color: #ddd;
                color: black;
            }
              
            .topnav a.active {
                background-color: #0b304d;
                color: white;
            }
              
            .topnav .search-container {
                float: right;
            }
              
            .topnav input[type=text] {
                padding: 6px;
                margin-top: 8px;
                font-size: 17px;
                border: none;
            }
              
            .topnav .search-container button {
                float: right;
                padding: 6px 10px;
                margin-top: 8px;
                margin-right: 16px;
                background: #ddd;
                font-size: 17px;
                border: none;
                cursor: pointer;
            }
              
            .topnav .search-container button:hover {
                background: #ccc;
            }
              
            @media screen and (max-width: 600px) {
                .topnav .search-container {
                  float: none;
                }
                .topnav a, .topnav input[type=text], .topnav .search-container button {
                  float: none;
                  display: block;
                  text-align: left;
                  width: 100%;
                  margin: 0;
                  padding: 14px;
                }
                .topnav input[type=text] {
                  border: 1px solid #ccc;  
                }
            }
            
        </style>
	</head>
	<body>
        <!-- Navigation bar locked to the top of the screen -->
        <div class="topnav">
            <a href="{{ url_for('homepage') }}">Home</a>
            <a class="active" href="{{ url_for('library') }}">Library</a>
            <a href="{{ url_for('playlists') }}">Playlists</a>
            <a href="{{ url_for('friends') }}">Friends</a>
            <div class="search-container">
                <form action="{{ url_for('search') }}" method="post">
                    <input type="text" placeholder="Search" name="search" value="{{ request.form.search }}">
                    <button type="submit"><i class="fa fa-search"></i></button>
                </form>
            </div>
        </div>
        
        {% if data['songs']|length == 0 %}
        <p style="color: red">No songs saved!</p>
        {% else %}
        <table id="library">
            <tr>
                <th></th>
                <th></th>
                <th>Title</th>
                <th></th>
                <th>Artist</th>
                <th>Album</th>
                <th>Plays</th>
                <th>Duration</th>
            </tr>
            {% for song in data['songs'] %}
            <tr>
                <td style="text-align: center">
                    <audio id="audio" src="/static/{{ song[7] }}" type="audio/mpeg" ontimeupdate="updateBar(this)">
                        Your browser does not support the audio element.
                    </audio> 
                    <button onclick="togglePlayPause(this)" type="button" id="play" class='far fa-play-circle'></button> 
                </td>
                <td style="text-align: center">
                    <form action="{{ url_for('library') }}" method="post">
                        <button type="submit" id="saved" name="delete-song" value="{{ song[0] }}" onmouseover="this.className='fas fa-times'" onmouseout="this.className='fas fa-check'" class='fas fa-check'></button>
                    </form>
                </td>
                <td>{{ song[2] }}</td> <!-- song -->
                {% if song[1] == 'Yes' %}
                <td><img src="https://i.stack.imgur.com/tkB9m.png"></td> <!-- explicit (display logo) -->
                {% else %}
                <td></td> <!-- not explicit -->
                {% endif %}
                <td>{{ song[8] }}</td> <!-- artist -->
                <td>{{ song[4] }}</td> <!-- album -->
                <td>{{ song[5] }}</td> <!-- plays -->
                <td id="duration">{{ song[6] }}</td> <!-- duration -->
            </tr>
            {% endfor %}
        </table>
        {% endif %}

        <!-- really crappy progress bar implementation -->
        <div class="navbar">
            <div class="timebar" style="text-align:center">
                <div class="w3-light-grey w3-round-xlarge" style="width:50%">
                    <div class="w3-blue w3-round-xlarge" id="progressBar" style="width:0; height:10px"></div>
                </div>
            </div>
        </div>


        <script>
            // a basic queue data structure for maintaining songs
            class Queue {
                constructor() {
                    this.items = [];
                }

                enqueue(element) {
                    this.items.push(element);
                }

                dequeue() {
                    if (this.isEmpty())
                        return "Underflow";
                    return this.items.shift();
                }

                isEmpty() {
                    return this.items.length == 0;
                }
            }

            var songQueue = new Queue();    // holds the current playing song to prevent songs from playing over each other
            var buttonQueue = new Queue();  // holds the buttons for switching between play/pause buttons when a user interacts
            var totalQueue = new Queue();   // holds the song IDs of all songs played by the user before leaving/reloading the page
            var songs = document.querySelectorAll('#audio');    // list all audio players in the above HTML
            var buttons = document.querySelectorAll('#play');   // list all buttons in the above HTML
            var lastSongIndex = -1; // initialization
            
            function togglePlayPause(button) {
                var currentSongIndex;
                // find the index of the button the user pressed to handle the song (with the same index)
                for (var i = 0; i < buttons.length; i++) {
                    if (buttons[i] == button) {
                        currentSongIndex = i;
                    }
                }

                // if the music is paused, play it, otherwise pause it (and deal with queues/attributes appropriately)
                if (button.className == 'far fa-play-circle') {
                    button.className = 'far fa-pause-circle';
                    button.id = 'pause';
                    if (!songQueue.isEmpty()) {
                        var prevSong = songQueue.dequeue();
                        prevSong.pause();
                        var prevButton = buttonQueue.dequeue();
                        prevButton.className = 'far fa-play-circle';
                        prevButton.id = 'play';
                    }
                    // if it's not the same song that was playing, restart it and add it to the total queue
                    if (lastSongIndex !== currentSongIndex) {
                        songs[currentSongIndex].currentTime = "0";
                        var songID = button.value;
                        totalQueue.enqueue(songID);
                    }

                    // new standards require a promise be handled by JavaScript when playing a song
                    var promise = songs[currentSongIndex].play();
                    if (promise !== undefined) {
                        promise.then(_ => {
                            // Autoplay started!
                        }).catch(error => {
                            // Autoplay was prevented.
                        });
                    }
                    
                    lastSongIndex = currentSongIndex;
                    songQueue.enqueue(songs[currentSongIndex]);
                    buttonQueue.enqueue(button);

                    // when the song has ended, dequeue it from currently played and change its button type
                    songs[currentSongIndex].addEventListener('ended', function() {
                        songQueue.dequeue();
                        var prevButton = buttonQueue.dequeue();
                        prevButton.className = 'far fa-play-circle';
                        prevButton.id = 'play';
                    });
                } else {
                    songs[currentSongIndex].pause();
                    songQueue.dequeue();
                    buttonQueue.dequeue();
                    button.className = 'far fa-play-circle';
                    button.id = 'play';
                }
                
            }

            // Progress bar of the currently playing song
            function updateBar(audio) {
                var bar = document.getElementById("progressBar");
                var currentTime = audio.currentTime;
                var duration = audio.duration;
                var percentage = currentTime / duration * 100;
                bar.style.width = percentage + '%';
            }

            // Converts durations from seconds to hours, minutes, and seconds
            var durations = document.querySelectorAll("#duration");
            for (var i = 0; i < durations.length; i++) {
                durations[i].innerHTML = timeFormat(durations[i].innerHTML);
            }

            // Turns seconds format into hours, minutes, and second format for shown duration
            function timeFormat(time) {   
                // Hours, minutes and seconds
                var hrs = ~~(time / 3600);
                var mins = ~~((time % 3600) / 60);
                var secs = ~~time % 60;
                var ret = "";
                if (hrs > 0) {
                    ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
                }
                ret += "" + mins + ":" + (secs < 10 ? "0" : "");
                ret += "" + secs;
                return ret;
            }

            // Sends a POST request containing the IDs of the songs played to update
            // the number of plays for each song when a user goes to leave the page
            window.onbeforeunload = function(event) {
                var request = new XMLHttpRequest();
                request.open("POST", "/library", true);
                request.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
                request.send("items="+totalQueue.items);
            };
        </script>
	</body>
</html>